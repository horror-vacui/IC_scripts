#!/usr/bin/python
# Initial version - zti 2018-01-15

import argparse
import os

parser = argparse.ArgumentParser(description="Script to make netlisting easier from the command line")
parser.add_argument("-l", "--library", help="library name of the design to be netlisted", default=False, required=True)
parser.add_argument("-c", "--cell", help="cell name of the design to be netlisted", default=False, required=True)
parser.add_argument("-v", "--view", help="cellview name of the design to be netlisted", default=False, required=True)
parser.add_argument("-d", "--dir", help="specify the path to the df2 directory in your workspace. (Workspace= your 'username' directory.) Relative paths are referenced to the user's workspace.", default="", required=False)
parser.add_argument("-s", "--simdir", help="simulation directory, i.e. where the netlist should be created. Relative paths are related to the df2 directory", default="", required=False)
parser.add_argument("-f", "--tempfile", help="temporary ocean file", default="", required=False)
parser.add_argument("-q", "--quiet", help="Does not run the netlisting, just generates the temporary ocean file used for netlisting", action="store_true", required=False)
args = parser.parse_args()

# Should the .ocn_netlist.ocn file generated in the simdir? - Seems logical

pwd = os.getcwd()

# ocean needs to be started form the df2 directory,otherwise the cds.lib will be overwritten. It might not be the case at other locations. 
icpro_dir=os.environ.get("ICPRO_DIR")
assert icpro_dir, "The needed environment variables are not defined. Try run icpro first."
if args.dir != "": 
	if args.dir[0] != "/":
		df2_dir = os.path.join(icpro_dir,args.dir)
	else:
		df2_dir = args.dir
else: 
	df2_dir = "./"
os.chdir(df2_dir)

print("df2 directory: " + os.path.abspath(df2_dir))		

# Writing the ocean file for netlisting
if args.tempfile == "":
	tmp_filename = ".nl_" + args.library + "_" + args.cell + "_" + args.view + ".ocn"
else:
	tmp_filename = args.tempfile
f_tmp = open(tmp_filename,'w')
f_tmp.write(";Autogenerated netlisting ocean file\n")
if args.simdir != "":
	if args.simdir !=	"/":
		sim_dir = os.path.join(icpro_dir, args.simdir)
	else:
		sim_dir = args.simdir
	f_tmp.write("envSetVal( \"asimenv.startup\" \"projectDir\" 'string \"" + sim_dir + "\" ) \n" )
f_tmp.write("simulator('spectre) \n")
f_tmp.write("design(\"" + args.library + "\" \"" + args.cell + "\" \"" + args.view + "\") \n")  
f_tmp.write("createNetlist( ?recreateAll t ?display nil) \n")
f_tmp.close()

if not args.quiet:
	os.system("ocean < " + tmp_filename)
